<ContextMenu x:Class="DataSphere.Controls.ContextMenus"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="clr-namespace:Wpf.Ui.Controls;assembly=Wpf.Ui"
             xmlns:models="clr-namespace:DataSphere.Models"
             xmlns:helpers="clr-namespace:DataSphere.Helpers"
             xmlns:controls="clr-namespace:DataSphere.Controls">
    <ContextMenu.Style>
        <Style TargetType="ContextMenu" BasedOn="{StaticResource {x:Type ContextMenu}}"/>
    </ContextMenu.Style>

    <ContextMenu.Resources>
        <helpers:PreferNotNullConverter x:Key="PreferNotNullConverter" />
        <!-- Template cho MenuItem -->
        <HierarchicalDataTemplate DataType="{x:Type models:ContextAction}" 
                                  ItemsSource="{Binding Children}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <ContentControl Grid.Column="0" 
                               Content="{Binding Icon}" 
                               Margin="0,2,8,0"
                               Visibility="{Binding Icon, Converter={StaticResource NullToVisibilityConverter}}"/>
                <TextBlock Grid.Column="1" 
                          Text="{Binding Name}" 
                          VerticalAlignment="Center"/>
            </Grid>
        </HierarchicalDataTemplate>

        <!-- Converter để ẩn icon nếu null -->
        <helpers:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>

        <Style TargetType="MenuItem" BasedOn="{StaticResource {x:Type MenuItem}}"/>
    </ContextMenu.Resources>

    <ContextMenu.ItemContainerStyle>
        <Style TargetType="MenuItem" BasedOn="{StaticResource {x:Type MenuItem}}">
            <Setter Property="Command" Value="{Binding Command}" />
            <Setter Property="CommandParameter">
                <Setter.Value>
                    <MultiBinding Converter="{StaticResource PreferNotNullConverter}">
                        <!-- Ưu tiên parameter từ chính ContextAction -->
                        <Binding Path="CommandParameter" />
                        <!-- Fallback: lấy từ ContextMenus.Parameter -->
                        <Binding RelativeSource="{RelativeSource AncestorType={x:Type controls:ContextMenus}}" Path="Parameter" />
                    </MultiBinding>
                </Setter.Value>
            </Setter>
            <Setter Property="IsEnabled" Value="{Binding IsEnabled}" />
        </Style>
    </ContextMenu.ItemContainerStyle>
</ContextMenu>